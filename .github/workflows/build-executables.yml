name: Build Executables

# 触发条件：
# - push到main分支：构建可执行文件并上传artifacts（保留30天）
# - 创建tag：构建可执行文件并创建GitHub Release（保留90天）
# - 手动触发：可手动运行workflow

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

# 权限设置
permissions:
  contents: write

jobs:
  # 构建可执行文件的job，在main分支push或tag创建时触发
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            ext: ""
          - os: windows-latest
            platform: windows
            arch: x86_64
            ext: ".exe"
          - os: macos-15-intel
            platform: macos
            arch: x86_64
            ext: ""
          - os: macos-latest
            platform: macos
            arch: arm64
            ext: ""

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install nuitka zstandard

    - name: Build executable with Nuitka
      shell: bash
      run: |
        fname="epuber-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.ext }}"
        python -m nuitka \
          --onefile \
          --standalone \
          --follow-imports \
          --output-filename="$fname" \
          main.py
        echo "Built file:"
        ls -l "$fname"

    - name: Show dist contents
      run: |
        echo "Dist directory contents:"
        ls -l dist || true

    - name: Verify build architecture
      shell: bash
      run: |
        actual="$(uname -m)"
        expected="${{ matrix.arch }}"
        echo "Expected arch: ${expected}, actual: ${actual}"
        if [ "${expected}" = "x86_64" ] && [ "${actual}" != "x86_64" ]; then
          echo "Architecture mismatch!" >&2
          exit 1
        fi
        if [ "${expected}" = "arm64" ] && [ "${actual}" != "arm64" ]; then
          echo "Architecture mismatch!" >&2
          exit 1
        fi

    - name: Normalize Windows executable extension
      if: matrix.platform == 'windows'
      shell: bash
      run: |
        base="dist/epuber-${{ matrix.platform }}-${{ matrix.arch }}"
        if [ -f "${base}.exe" ]; then
          echo "Found ${base}.exe"
        elif [ -f "${base}" ]; then
          echo "Renaming ${base} -> ${base}.exe"
          mv "${base}" "${base}.exe"
        else
          echo "No executable found in dist/"
          ls -l dist || true
          exit 1
        fi
        ls -l dist

    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: epuber-${{ matrix.platform }}-${{ matrix.arch }}
        path: epuber-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.ext }}
        if-no-files-found: error
        retention-days: ${{ github.ref_type == 'tag' && 90 || 30 }}

  # 只有在创建tag时才创建GitHub Release
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create release archives
      run: |
        cd artifacts
        for dir in */; do
          if [[ "$dir" == *"linux"* ]] || [[ "$dir" == *"macos"* ]]; then
            chmod +x "$dir"*
            tar -czf "${dir%/}.tar.gz" -C "$dir" .
          else
            zip -r "${dir%/}.zip" "$dir"
          fi
        done

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*.tar.gz artifacts/*.zip
        generate_release_notes: true