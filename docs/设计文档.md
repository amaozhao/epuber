## **epuber 项目设计文档**

### 1. 项目概述

#### 1.1. 项目目标
`epuber` 是一个轻量级的命令行工具，旨在为用户提供一种快速、简便的方式，将本地的 TXT 格式小说文件转换为标准的 EPUB 格式电子书 。项目的主要目标是自动化处理流程，通过智能识别**分层章节结构**（如“卷”和“章”），生成包含多级目录、排版美观的 EPUB 文件，以显著提升纯文本小说的阅读体验 。

#### 1.2. 核心功能
*   **文件读取**：接收用户指定的 TXT 小说文件作为输入 。
*   **分层章节提取**：使用正则表达式技术和状态机逻辑，自动从文本内容中识别并提取“卷-章”或独立的章节标题及对应的正文内容 。
*   **EPUB 打包**：利用 `ebooklib` 库，将提取出的分层章节内容组织成符合 EPUB 标准的结构化文档，并生成兼容性强的导航目录 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。
*   **样式增强**：自动嵌入默认的 CSS 样式表，优化章节标题和正文段落的显示效果 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。
*   **文件生成与保存**：将打包好的电子书以与原 TXT 文件同名的 EPUB 文件形式，保存到用户指定的目录或默认目录 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。

#### 1.3. 目标用户
*   喜欢在本地下载和整理 TXT 格式网络小说的读者 。
*   希望将个人文稿、笔记等长文本内容转换为易于在移动设备上阅读的电子书格式的用户 。
*   需要进行批量文本转换的程序员或技术爱好者 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。

### 2. 功能拆解

为了实现核心目标，我们将项目拆解为以下几个关键功能模块：

#### 2.1. 命令行接口 (CLI) 模块
这是用户与程序交互的入口，负责解析用户输入的命令和参数。为保证健壮性和良好的用户体验，建议使用 `typer` 库构建，并集成 `rich` 库进行美化输出 。
*   **输入文件参数 (`<input_file>`)**: 必须参数。用于指定待转换的 TXT 小说的完整路径。`typer` 库可以提供强大的内置验证，如 `exists=True` (文件必须存在) 和 `readable=True` (文件必须可读)，在程序核心逻辑执行前完成检查 。
*   **输出目录参数 (`-o` 或 `--output`)**: 可选参数。用于指定生成的 EPUB 文件的存放目录。如果用户未提供此参数，程序应将 EPUB 文件保存在与原 TXT 文件相同的目录 。
*   **作者参数 (`-a` 或 `--author`)**: 可选参数。用于设置 EPUB 的作者元数据。如果未提供，可设为“未知作者”等默认值 。
*   **自定义正则表达式参数**: 可选参数。支持分别自定义不同类型的正则表达式，以适应不同的文本格式：
    *   `--volume-regex`: 自定义卷标题正则表达式
    *   `--chapter-regex`: 自定义章节标题正则表达式
    *   `--exclude-regex`: 自定义排除模式正则表达式
    *   程序为每种类型都内置了合理的默认正则表达式
*   **详细日志标志 (`-v` 或 `--verbose`)**: 可选标志 (flag)。启用后，程序将打印详细的执行步骤日志，便于用户了解转换过程或进行问题排查 。

#### 2.2. 文件读取模块
该模块负责处理文件的读取和初步校验 。
*   **路径验证**：检查用户提供的输入文件路径是否存在且为文件。此步骤可由 `typer` 的参数验证功能自动完成 。
*   **文件读取**：将 TXT 文件的全部内容读取到内存中 。
*   **编码处理**：程序使用智能编码检测算法（`chardet`库）自动识别文件编码，并按UTF-8优先、多种中文编码fallback的策略处理。当检测到高置信度的编码时直接使用，否则按顺序尝试UTF-8、GBK、GB2312、Big5、UTF-16等常见编码，确保最大兼容性。

#### 2.3. 分层章节提取与格式化模块
这是项目的核心逻辑所在，负责从纯文本中识别出结构化的、适合生成多级目录的 EPUB 内容。此模块的设计将采用基于状态机的逐行解析模式，以支持分层结构 。

*   **数据结构定义**：为了承载分层数据，需要定义清晰的数据结构。推荐使用 `NamedTuple` 或 `dataclasses` 来实现 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。
    *   `Chapter` 类：用于存储单个章节信息，至少包含 `title` (标题) 和 `content` (内容) 两个属性 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。
    *   `Volume` 类：用于存储分卷信息，至少包含 `title` (卷标题) 和一个 `chapters` 列表（用于存放该卷下的所有 `Chapter` 对象）。

*   **正则表达式策略**：模块将使用多个可配置的正则表达式来驱动解析 。
    1.  **一级目录模式 (`level1_pattern`)**: 用于匹配“卷”、“部”、“篇”等一级标题，以及“楔子”、“番外”等特殊的独立顶级章节 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。
    2.  **二级目录模式 (`level2_pattern`)**: 用于匹配“章”、“回”、“节”等二级标题 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。
    3.  **排除模式 (`exclude_pattern`)**: 用于匹配并忽略那些可能被误判为标题的行，如“版权声明”等 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。
    *   这些正则表达式可以作为内部默认值，并允许用户通过 CLI 参数（如 `--volume-regex`, `--chapter-regex`, `--exclude-regex`）进行覆盖，以提供最大的灵活性 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。

*   **核心解析逻辑 (状态机)**：解析过程将通过逐行扫描文本并维护一个状态来实现 。
    1.  **初始化状态**：定义两个状态变量 `current_volume` 和 `current_chapter`，初始值均为 `None` 。
    2.  **优先级匹配**：对每一行文本，严格按照“**排除模式 -> 一级目录模式 -> 二级目录模式**”的优先级顺序进行匹配 。
    3.  **一级目录处理**：当匹配到一级目录时，创建相应的 `Volume` 或 `Chapter` 对象，并正确管理 `current_volume` 状态 。
    4.  **二级目录处理**：当匹配到二级目录时，创建新的 `Chapter` 对象，并根据 `current_volume` 是否存在，将其归入卷中或作为顶级章节 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。
    5.  **内容追加**：如果某一行不匹配任何标题模式，则将其视为正文，追加到 `current_chapter` 的 `content` 属性中 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。

*   **输出**：该模块最终返回一个 `List[Union[Volume, Chapter]]` 类型的列表，该列表精确地反映了小说的完整层级结构，可直接供后续的 EPUB 生成模块使用 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。

#### 2.4. EPUB 生成模块
该模块利用 `ebooklib` 库将处理好的**分层数据**打包成 EPUB 文件。此模块的设计将重点关注如何精确生成嵌套目录和保证多设备兼容性 。

*   **书籍元数据设置**：
    *   **书名 (Title)**：从输入的 TXT 文件名中提取（例如，`我的小说.txt` -> `我的小说`）。
    *   **作者 (Author)**：使用用户通过 `--author` 参数提供的值，或使用默认值 。
    *   **语言 (Language)**：默认为中文 (`zh`) 。
    *   **唯一标识符 (Identifier)**：为每本书生成一个唯一的标识符。推荐使用 `urn:uuid:{book_title}-{author}` 这种简单确定性的格式，或使用 `uuid.uuid4()` 生成 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。

*   **CSS 样式嵌入**：为提升阅读体验，程序应内置一套默认的 CSS 样式，并将其嵌入 EPUB 文件中 。
    *   **样式设计**：CSS 应至少包含对章节大标题 (`h1`) 和正文段落 (`p`) 的样式定义。例如，将 `h1` 居中加粗，并为 `p` 标签设置 `text-indent: 2em;` 以实现段落首行缩进，增加 `line-height` 也能显著提升阅读舒适度 。
    *   **嵌入与链接**：使用 `ebooklib` 创建一个 `EpubItem` 代表 CSS 文件，并将其添加到书中。随后，在创建每个章节的 `EpubHtml` 对象时，将其与该 CSS 文件进行链接 。

*   **内容创建与目录 (TOC) 生成**：
    *   遍历由解析模块生成的 `List[Union[Volume, Chapter]]` 结构 。
    *   为每个 `Chapter` 对象创建一个 `EpubHtml` 页面。在生成 HTML 内容时，应将纯文本正文进行转换，例如将换行符 `\n` 替换为 `</p><p>`，以生成符合语义的段落 。
    *   **生成嵌套目录 (TOC)**：`ebooklib` 使用一个由元组构成的列表来定义层级目录 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。
        *   如果一个元素是顶级的 `Chapter`，则直接将其对应的 `EpubHtml` 对象添加到 TOC 列表中 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。
        *   如果一个元素是 `Volume`，则在 TOC 列表中添加一个 `(epub.Section(item.title), tuple(volume_chapters_toc))` 形式的元组。其中 `epub.Section` 创建一个不可点击的分组标题，而元组的第二项是该卷下所有章节 `EpubHtml` 对象的集合，它们会自动成为该分组下的二级链接 。

*   **导航文件与兼容性**：为了确保电子书在所有阅读器上都有良好的目录体验，必须同时生成 EPUB 2 (`toc.ncx`) 和 EPUB 3 (`nav.xhtml`) 标准的导航文件 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。`ebooklib` 通过 `book.add_item(epub.EpubNcx())` 和 `book.add_item(epub.EpubNav())` 可以自动完成此过程 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。

*   **书脊 (Spine) 设置**：书脊定义了内容的线性阅读顺序 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。它是一个列表，为了符合 EPUB 3 标准，其**第一项必须是字符串 `'nav'`**，指向 NAV 导航文件，随后按阅读顺序添加所有章节页面 。

#### 2.5. 文件输出模块
负责将内存中生成的 EPUB 对象写入到物理文件中 。
*   **输出路径处理**：根据用户的 `-o` 参数或默认规则（输入文件所在目录），确定最终的输出文件路径 。
*   **文件名确定**：EPUB 文件名应与原始 TXT 文件名保持一致，仅扩展名不同（例如 `我的小说.txt` -> `我的小说.epub`）。
*   **文件写入**：调用 `ebooklib` 的 `epub.write_epub()` 功能保存文件。如果输出目录不存在，程序应尝试自动创建它 (`path.mkdir(parents=True, exist_ok=True)`) 。

### 3. 核心工作流程

1.  **启动**：用户在命令行中执行 `epuber convert` 命令，并提供 TXT 文件路径及可选参数 。
2.  **参数解析与验证**：程序解析所有输入参数。`typer` 在此阶段自动验证文件是否存在、可读，以及输出目录是否可写 。
3.  **内容读取与解码**：程序尝试以 `UTF-8` 编码读取 TXT 文件，失败则回退至 `GBK` 。
4.  **分层章节解析**：程序使用预设或用户自定义的正则表达式和状态机逻辑，对文本内容进行逐行扫描，生成一个包含 `Volume` 和 `Chapter` 对象的结构化列表 。
5.  **EPUB 初始化**：程序创建一个新的 `EpubBook` 对象，并根据文件名和输入参数设置书名、作者、语言和唯一的标识符 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。
6.  **样式嵌入**：将内置的默认 CSS 样式作为资源添加到 EPUB 书籍中 。
7.  **内容填充与嵌套目录生成**：程序遍历分层数据结构，为每一章创建 `EpubHtml` 页面，并根据 `Volume` 和 `Chapter` 的关系生成一个带嵌套的目录（TOC）结构 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。
8.  **导航文件生成**：程序自动添加 EPUB 2 (`EpubNcx`) 和 EPUB 3 (`EpubNav`) 导航文件定义，以确保最佳兼容性 。
9.  **书脊设置**：按 `'nav'` 在前，其余章节在后的顺序设置书籍的书脊（Spine）。
10. **文件打包与保存**：所有内容处理完毕后，程序将它们打包成一个完整的 EPUB 文件，并根据指定的输出目录和原始文件名，将文件写入磁盘 。
11. **完成**：程序执行完毕，使用 `rich` 库向用户显示带颜色和图标的成功信息或错误提示 。

### 4. 异常情况处理

为了保证工具的鲁棒性，必须考虑并妥善处理以下异常情况。建议结合 `try...except` 块和 `typer.Exit(code=1)` 来实现优雅的错误处理和退出，并使用 `rich` 库打印用户友好的错误信息 。

| 异常情况 | 描述 | 处理策略 |
| :--- | :--- | :--- |
| **输入文件不存在或不可读** | 用户提供的 TXT 文件路径无效，或文件因权限问题无法读取。 | 程序应立即终止，并返回明确的错误信息。使用 `typer` 可在执行前自动处理 。 |
| **输出目录无效或不可写** | 用户指定的输出目录不存在且无法被创建，或因权限问题无法写入文件。 | 程序应终止执行，并返回错误信息，如：“错误：权限不足，无法创建或写入输出目录 'path/to/output'。” 。 |
| **编码错误** | 文件不是 `UTF-8` 或 `GBK` 编码，导致两次尝试解码均失败。 | 捕获 `UnicodeDecodeError` 异常，终止程序并提示用户：“错误：无法解码文件。请确保文件为 UTF-8 或 GBK 编码。” [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。 |
| **正则表达式错误** | 用户通过 `--volume-regex`, `--chapter-regex` 或 `--exclude-regex` 参数提供了无效的正则表达式。 | 捕获 `re.error` 异常，终止程序并提示用户检查其提供的正则表达式语法是否正确 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。 |
| **未找到任何章节** | 预设或用户自定义的正则表达式无法在文件中匹配到任何章节标题。 | 程序不应生成空 EPUB。应终止执行，并提示用户：“错误：未能在文件中找到任何章节。请检查文件内容或正则表达式。” 。 |
| **文件写入失败** | 在最后保存 EPUB 文件时，因磁盘空间已满或权限问题导致写入失败。 | 程序应捕获此 `IOError` 或 `PermissionError` 异常，并向用户报告写入失败，提示可能的原因 。 |
| **未知错误** | 发生任何未预料到的异常。 | 捕获通用 `Exception`，打印详细的错误回溯信息（尤其是在 `--verbose` 模式下），并向用户显示一个通用的错误消息后退出 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。 |

### 5. 项目范围与未来展望

#### 5.1. 初期版本范围
为确保项目能够快速实现核心价值，初期版本将明确以下范围：
*   **仅支持 TXT 输入**：不兼容 `doc`, `pdf` 等其他格式 。
*   **支持两级章节结构**：支持“卷-章”或独立的顶级章节结构，能够生成嵌套目录 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。
*   **无图形界面**：完全基于命令行操作 。
*   **可配置的元数据**：支持通过命令行参数设置作者，书名则自动从文件名获取 。
*   **可配置的正则表达式**：支持用户在运行时通过参数自定义章节匹配规则 。
*   **增强的用户反馈**：使用 `rich` 库提供带颜色的日志和状态消息，并通过 `--verbose` 标志提供分级日志 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。

#### 5.2. 潜在的未来增强
*   **交互式进度条**：在处理大型文件时，使用 `rich` 的进度条功能向用户显示实时进度 。
*   **高级编码检测**：集成 `chardet` 库，实现更准确的文件编码自动检测 。
*   **支持更多元数据**：允许用户通过命令行参数添加封面图片、出版商等更丰富的元数据 [[1]](https://rich.readthedocs.io/en/latest/logging.html) 。
*   **配置文件支持**：允许用户通过一个配置文件（如 `~/.config/epuber/config.toml`）来预设常用的作者名、正则表达式等，避免每次都在命令行输入。

### 6. 打包与分发设计

为了让 `epuber` 成为一个用户可以轻松安装和使用的工具，设计上应考虑现代化的 Python 打包方案 。
*   **打包工具**：推荐使用 `Poetry` 或 `Hatch` 等现代工具，它们通过 `pyproject.toml` 文件管理项目元数据、依赖和构建配置 。
*   **配置文件 (`pyproject.toml`)**：
    *   **项目元数据**：应包含项目名称（如 `epuber`）、版本号、描述、作者、许可证等信息 。
    *   **依赖声明**：明确声明项目运行所需的核心依赖，如 `typer[all]`, `ebooklib` 。
    *   **命令行入口点**：这是设计的关键。需要在 `[project.scripts]` (或 `[tool.poetry.scripts]`) 部分配置一个入口点，例如 `epuber = "epuber.main:app"` 。这个配置会确保在通过 `pip` 安装后，系统会自动创建一个名为 `epuber` 的可执行命令，它会调用我们 Python 脚本中的 `typer` 应用实例 。
*   **分发方式**：通过此设计，项目可以被构建为标准的 wheel (`.whl`) 和 sdist (`.tar.gz`) 包，用户可以通过 `pip install` 进行安装，或进一步发布到 PyPI 以供全球用户下载 。

---

### **执行摘要**

本文档为 `epuber` 项目提供了一份修订后的设计方案。该项目旨在创建一个简单高效的命令行工具，用于将 TXT 小说转换为格式优美的 EPUB 电子书 。设计上，项目被拆解为命令行接口、文件读取、分层章节提取、EPUB 生成和文件输出五个核心模块，并新增了打包与分发的设计考量 。

与初稿相比，本设计方案在保持核心功能（如**支持分层章节和嵌套目录**）的基础上，吸收了参考资料中的多个实践优点，显著提升了设计的完整性和实用性 。主要增强点包括：
1.  **功能更丰富的命令行接口**：设计了包括自定义作者 (`--author`)、分类型自定义正则表达式 (`--volume-regex`, `--chapter-regex`, `--exclude-regex`) 和详细日志 (`--verbose`) 在内的多个命令行参数，提升了工具的灵活性和易用性 。
2.  **更佳的用户体验**：明确将 `rich` 库的集成纳入初期设计，用于提供带颜色的、清晰的日志和错误反馈，改善了纯命令行工具的交互体验 。
3.  **对分层解析的坚持与优化**：保留了原设计中支持“卷-章”两级结构的核心解析逻辑，因为它直接响应了用户的“分层”需求，同时增加了通过命令行配置正则表达式的灵活性 。
4.  **明确的打包与分发路径**：新增了关于如何使用 `pyproject.toml` 将项目打包成一个可通过 `pip` 安装的可执行命令的设计，使项目从一个脚本构想，演进为一个完整的、可分发的应用方案 。

这份修订后的设计在遵循“基础功能优先”原则的同时，通过整合具体实现中的优秀实践，使整体方案更具深度和可操作性，为后续的开发工作提供了一份清晰、务实且具有前瞻性的蓝图 [[1]](https://rich.readthedocs.io/en/latest/logging.html)[[2]](https://rich.readthedocs.io/en/stable/reference/logging.html) 。